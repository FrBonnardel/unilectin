var currentWin=window,main_NGL_module=null,main_pv=null,main_ngl=null,plip_bond_num_dash=5,plip_bond_radius=.1,plip_higlight_factor=2,plip_higlight_bond_num_dash=1,PLIP=PLIP||{};PLIP.AbstractViewer=null;var opacity_fadeout_ligand=.3,opacity_fadeout_protein=.3;
function takeSnapshot(b){".png"==b&&(b="structure.png");0<$("#pv:visible",currentWin.document).length&&$("#pv canvas")[0].toBlob(function(a){saveAs(a,b)});0<$("#ngl:visible",currentWin.document).length&&ngl_stage.makeImage({factor:1,antialias:!0,trim:!1,transparent:!1}).then(function(a){NGL.download(a,b)})}
function resetStructure(){0<$("#pv:visible",currentWin.document).length&&(pv_viewer.show("*ligands"),pv_viewer.hide("*ligands_lines"),pv_viewer.rm("*res"),pv_viewer.autoZoom(),pv_viewer.requestRedraw());0<$("#ngl:visible",currentWin.document).length&&ngl_stage.compList[0].autoView(1200)}function spin(b){"undefined"!==typeof pv_viewer&&pv_viewer.spin(b);null!=ngl_stage&&(b?ngl_stage.setSpin([0,1,0],-.005):ngl_stage.setSpin(0))}
function detach(b){if(currentWin==window){if(0<$("#pv:visible",currentWin.document).length)currentWin=window.open(b.replace("xx","pv"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700"),main_pv=pv_viewer;else if(0<$("#ngl:visible",currentWin.document).length)main_ngl=ngl_stage,main_NGL_module=NGL,currentWin=window.open(b.replace("xx","ngl"),"_blank","resizable=1,status=1,toolbar=1,location=1,height=700,width=700");else return;$("#left-panel").removeClass("col-sm-8");$("#right-panel").hide();
$(".alignTbl").alignment("resizeToParent")}}function refreshBondsAndLigandHighlights(){refreshHighlightLigands();refreshBonds()}function refreshBonds(){plip_bonds.refreshAll()}function refreshHighlightLigands(){strucIds=all_ligands.listStruc();all_ligands.redrawAll()}function attachPV(){pv_viewer=main_pv;attach()}function attachNGL(){var b=ngl_stage.viewerControls.getOrientation();NGL=main_NGL_module;ngl_stage=main_ngl;ngl_stage.removeAllComponents();showNGL(b);attach()}
function attach(){currentWin=window;$("#left-panel").addClass("col-sm-8");$("#right-panel").show();$("#pv").height($("#viewerWrapper").width());0<$("#ngl:visible",currentWin.document).length&&($("#viewerWrapper").height($("#viewerWrapper").width()),ngl_stage.handleResize());"undefined"!=typeof superposeTemplates&&superposeTemplates(!0);$(".alignTbl").alignment("resizeToParent");refreshBondsAndLigandHighlights()}
function centerOnLigand(b,a){0<$("#pv:visible",currentWin.document).length&&centerOnLigandPV(b,a);0<$("#ngl:visible",currentWin.document).length&&centerOnLigandNGL(b,a)}
function highlightLigand(b,a,c){$(".hoverResidue").removeClass("hoverResidue");for(var d={},e=0;e<a.length;e++)a[e]&&"_"!=a[e].charAt(0)&&(res=a[e].substring(1),chain=a[e].charAt(0),d[chain]||(d[chain]=[]),d[chain].push(res));for(var f in d){var g=$("#alignTbl"+c+" tr[keyseqchain="+f+"]").find("span").toArray();if(0==g.length){var h=$(".alignTbl tr[chain="+f+"]:visible");if(0==h.length){var l=-1;$(".alignNameTbl tr[chain]:visible").each(function(){var a=$(this).closest(".alignNameTbl").attr("id").substring(12),
b=$(this).attr("seqno");if(!(parseInt(b)<l)){var c=$(this).text().split("(");c&&1<c.length&&-1<c[1].indexOf(f)&&(h=h.add($("#alignTbl"+a+" tr[seqno="+b+"]")),l=parseInt(b))}})}g=h.find("span").toArray()}for(e=0;e<d[f].length;e++)for(var k=0;k<g.length;k++)if(g[k].getAttribute("s")==d[f][e]){g[k].className="hoverResidue";break}}0<$("#pv:visible",currentWin.document).length&&highlightLigandPV(d,a,c);0<$("#ngl:visible",currentWin.document).length&&highlightLigandNGL(b,a,c)}
$("body").on("highlightResidue",function(b,a){if("structure"!=a.src)if(null==a.chain&&null==a.resno)0<$("#pv:visible",currentWin.document).length&&pv_viewer.rm(a.struc_id+"_res"),0<$("#ngl:visible",currentWin.document).length&&ngl_stage.getRepresentationsByName(a.struc_id+".hover").list[0].setSelection("none");else{if(0<$("#pv:visible",currentWin.document).length)return highlightResiduesPV(a.chain,a.resno,a.struc_id,a.multiple);if(0<$("#ngl:visible",currentWin.document).length)return highlightResiduesNGL(a.chain,
a.resno,a.struc_id,a.multiple)}});$("body").on("centerResRange",function(b,a){0<$("#pv:visible",currentWin.document).length&&centerResRangePV(a.chain,a.min,a.max,a.struc_id,a.isDisulfid);0<$("#ngl:visible",currentWin.document).length&&centerResRangeNGL(a.chain,a.min,a.max,a.struc_id,a.isDisulfid)});
function selectResidues(b,a,c,d){if(null==b&&null==a)0<$("#pv:visible",currentWin.document).length&&pv_viewer.rm(c+"_res"),0<$("#ngl:visible",currentWin.document).length&&ngl_stage.getRepresentationsByName(c+".hover").list[0].setSelection("none");else{if(0<$("#pv:visible",currentWin.document).length)return highlightResiduesPV(b,a,c,d);if(0<$("#ngl:visible",currentWin.document).length)return highlightResiduesNGL(b,a,c,d)}}
function changeRep(b){b||(b="cartoon");0<$("#pv:visible",currentWin.document).length&&(changeRepPV(b),null!=pv_viewer&&0<pv_viewer.all().length&&("undefined"!==typeof detached&&detached?window.opener.updatecols():updatecols()));0<$("#ngl:visible",currentWin.document).length&&(changeRepNGL(b),"undefined"!==typeof detached&&detached?window.opener.updatecols():updatecols())}function updatecols(){$(".alignTbl").first().alignment("viewerInitialised")}
var ngl_stage=null,ngl_picked_atom=!1,ngl_picked_component=!1;
function getNGL(){ngl_stage=new NGL.Stage("ngl",{backgroundColor:"white",hoverTimeout:.005,sampleLevel:2,tooltip:!1});var b=(new NGL.Matrix4).makeRotationX(Math.PI/2);b=(new NGL.Quaternion).setFromRotationMatrix(b);ngl_stage.viewerControls.rotate(b);b=(new NGL.Matrix4).makeRotationY(Math.PI);b=(new NGL.Quaternion).setFromRotationMatrix(b);ngl_stage.viewerControls.rotate(b);ngl_stage.signals.clicked.add(function(a){if(a&&(a.atom||a.bond)){var b=a.atom||a.closestBondAtom;a.component.autoView(b.resno+
":"+b.chainname,1E3)}});ngl_stage.signals.hovered.add(function(a){if(!ngl_stage.mouseObserver.pressed)if(a&&(a.atom||a.bond)){var b=a.atom||a.closestBondAtom;if(!ngl_picked_atom||b.structure.name!=ngl_picked_atom.structure.name||b.index!=ngl_picked_atom.index){var d=a.component,e=getNGLRepresentationByName(d.name,d.name),f=getNGLRepresentationByName(d.name,d.name+".residuesHighlight");ngl_picked_atom=b;ngl_picked_component=a.component;var g=b.resname+" "+b.resno+b.inscode;"_"!=b.chainname&&(g+=" "+
b.chainname);"_"!=b.chainname&&["cartoon","tube","rope"].includes(e.repr.type)&&"CA"==b.atomname||(g+=" "+b.atomname);$("#ngl_status").text(g);$("body").trigger("highlightResidue",{src:"structure",struc_id:a.component.name,chain:b.chainname,resno:b.resno});"surface"!=e.repr.type&&(replaceNGLRepresentation(d,e),f&&replaceNGLRepresentation(d,f),"undefined"!==typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecols()):updatecols())}}else ngl_picked_atom&&(d=ngl_picked_component,
e=getNGLRepresentationByName(d.name,d.name),f=getNGLRepresentationByName(d.name,d.name+".residuesHighlight"),replaceNGLRepresentation(d,e),f&&replaceNGLRepresentation(d,f),ngl_picked_atom=!1,$("#ngl_status").text(""),"undefined"!==typeof detached&&detached?(window.opener.ngl_picked_atom=ngl_picked_atom,window.opener.updatecols()):updatecols())});return ngl_stage}
function replaceNGLRepresentation(b,a){b.removeRepresentation(a);return b.addRepresentation(a.repr.type,{name:a.name,smoothSheet:a.getParameters().smoothSheet,roughness:a.getParameters().roughness,surfaceType:a.getParameters().surfaceType,probeRadius:a.getParameters().probeRadius,scaleFactor:a.getParameters().scaleFactor,sele:a.getParameters().sele,side:a.getParameters().side,opacity:a.getParameters().opacity})}
function getNGLComponentByName(b){for(var a in ngl_stage.compList)if(ngl_stage.compList[a].name==b)return ngl_stage.compList[a]}function getNGLRepresentationByName(b,a){comp=ngl_stage.getComponentsByName(b).list[0];for(var c in comp.reprList)if(comp.reprList[c].name==a)return comp.reprList[c]}function removeNGLComponentByName(b){b=getNGLComponentByName(b);ngl_stage.removeComponent(b)}
function highlightResiduesNGL(b,a,c,d){var e="",f;for(f in ngl_stage.compList)if(ngl_stage.compList[f].name==c){if(a)for(var g in ngl_stage.compList[f].reprList){if(ngl_stage.compList[f].reprList[g].name==c+".hover"){d&&(e=ngl_stage.compList[f].reprList[g].repr.selection.string+" ",e.startsWith("none")&&(e=e.substring(5)));c="";for(d=0;d<b.length;d++)if(a.length)for(var h=0;h<a.length;h++)c=a[h][0]==a[h][1]?c+(a[h][0]+":"+b[d]+" "):c+(a[h][0]+"-"+a[h][1]+":"+b[d]+" ");else c+=a+":"+b[d]+" ";ngl_stage.compList[f].reprList[g].setSelection(e+
c);break}}else{c="";if(1==b.length)c=a+":"+b;else for(d=0;d<b.length;d++)c+=a+":"+b[d]+" ";ngl_stage.compList[f].autoView(c,1E3)}return ngl_stage.compList[f].reprList[g].repr.selection.string}}
function centerResRangeNGL(b,a,c,d,e){var f="";if(1==b.length)f=e?f+(a+":"+b+" "+c+":"+b):f+(a+"-"+c+":"+b+" ");else for(var g=0;g<b.length;g++)f=e?f+(a+":"+b[g]+" "+c+":"+b[g]+" "):f+(a+"-"+c+":"+b[g]+" ");for(var h in ngl_stage.compList)if(ngl_stage.compList[h].name==d){ngl_stage.compList[h].autoView(f,1E3);break}}
function centerOnLigandNGL(b,a){for(var c=b[0]+":_",d=1;d<b.length;d++)c+=" "+b[d]+":_";for(var e in ngl_stage.compList)if(ngl_stage.compList[e].name==a){ngl_stage.compList[e].autoView(c,1E3);break}}
function highlightLigandNGL(b,a,c){removeNGLComponentByName(c+"ligandBondsHL");var d={},e=null;if(a&&0<a.length)for(var f=0;f<a.length;f++)if(a[f]){e=a[f].charAt(0);var g=parseInt(a[f].substring(1));"_"==e&&-1==b.indexOf(g)&&b.push(g);d[e]||(d[e]=[]);d[e][g]=1}g=a="";for(e in d){a+=" ( (";g+=" ( (";var h=!0;for(f=0;f<d[e].length;f++)if(d[e][f]){h?h=!1:(a+=" or ",g+=" or ");a+=f;g+=f-2;start=f;do f++;while(d[e][f]);1<f-start&&(a+="-"+(f-1));g+="-"+(f+1)}a+=") AND :"+e+") ";g+=") AND :"+e+") "}""==
a?(g=a="none",contactStringReversed="",fadeOutRepresentationNGL(c,c,1)):(contactStringReversed="NOT ("+g+")",fadeOutRepresentationNGL(c,c,opacity_fadeout_protein));for(var l in ngl_stage.compList)if(ngl_stage.compList[l].name==c){for(var k in ngl_stage.compList[l].reprList)ngl_stage.compList[l].reprList[k].name==c+".ligandsHover"&&ngl_stage.compList[l].reprList[k].setSelection(a),ngl_stage.compList[l].reprList[k].name==c+".residuesHighlight"&&ngl_stage.compList[l].reprList[k].setSelection(g);break}b&&
0<b.length?(b=":_ and ("+b.join(" or ")+")",fadeOutRepresentationNGL(c,c+".ligands",opacity_fadeout_ligand)):(b="none",fadeOutRepresentationNGL(c,c+".ligands",1));getNGLRepresentationByName(c,c+".ligandsHighlight").setSelection(b)}function fadeOutRepresentationNGL(b,a,c){repr=getNGLRepresentationByName(b,a,b);repr.setParameters({opacity:c})}
function changeRepNGL(b){$("#repBtnLbl").text(b.charAt(0).toUpperCase()+b.substring(1));jQuery.cookie("defaultRepr",b,{expires:365,path:"/"});switch(b){case "lines":b="line";break;case "ballAndStick":b="ball+stick";break;case "outline":return}var a=null;ngl_stage.eachRepresentation(function(c){if(!c.name.match(/(ligands|dna|over|buffer)/))for(comp in a=c.name.split(".")[0],ngl_stage.compList)ngl_stage.compList[comp].name==a&&(ngl_stage.compList[comp].removeRepresentation(c),ngl_stage.compList[comp].addRepresentation(b,
{name:c.name,sele:c.getParameters().sele,smoothSheet:!0,surfaceType:"sas",probeRadius:1.4,scaleFactor:Math.min(1.5,Math.max(.1,5E4/ngl_stage.compList[comp].structure.atomCount)),roughness:1,side:"front",opacity:c.getParameters().opacity}))})}function setColorForAtom(b,a,c){var d=b.structure().createEmptyView();d.addAtom(a);b.colorBy(pv.color.uniform(c),d)}var prevPicked=null;
document.getElementById("pv")&&document.getElementById("pv").addEventListener("mousemove",function(b){var a=pv_viewer.boundingClientRect();b=pv_viewer.pick({x:b.clientX-a.left,y:b.clientY-a.top});if(null===prevPicked||null===b||b.target()!==prevPicked.atom){null!==prevPicked&&setColorForAtom(prevPicked.node,prevPicked.atom,prevPicked.color);if(null!==b){a=b.target();var c=a.qualifiedName().split(".");if("_"!==c[0].charAt(0)&&a.residue()._isAminoacid){var d=[0,0,0,0];b.node().getColorForAtom(a,d);
prevPicked={atom:a,color:d,node:b.node()};setColorForAtom(b.node(),a,"red");$("body").trigger("highlightResidue",{src:"structure",struc_id:b.object().geom.name(),chain:c[0],resno:a.residue().num()});c=a.residue().name()+" "+a.residue().num()+" "+c[0]}else c=a.residue().name()+" "+a.residue().num();document.getElementById("pv_status").innerHTML=c}else document.getElementById("pv_status").innerHTML="",prevPicked=null;pv_viewer.requestRedraw()}});
function highlightResiduesPV(b,a,c,d){d||pv_viewer.rm(c+"_res");d=pv_viewer.get(c);if(null!=d){d=d.structure();if(a){var e=null;e=a.length?d.select({cnames:b.split("")}).residueSelect(function(b){for(var c=0;c<a.length;c++)if(b.num()>=a[c][0]&&b.num()<=a[c][1])return!0;return!1}):d.select({cnames:b.split("")}).residueSelect(function(b){return b.num()==a});pv_viewer.ballsAndSticks((c?c+"_":"")+"res",e);return e}pv_viewer.fitTo(d.select({cnames:b.split("")}));pv_viewer.requestRedraw()}}
function centerResRangePV(b,a,c,d,e){d=pv_viewer.get(d);if(null!=d){var f=null;f=1==b.length?d.structure().residueSelect(function(d){return e?(d.num()==a||d.num()==c)&&d.chain().name()==b:d.num()>=a&&d.num()<=c&&d.chain().name()==b}):d.structure().residueSelect(function(d){return e?(d.num()==a||d.num()==c)&&-1<b.indexOf(d.chain().name()):d.num()>=a&&d.num()<=c&&-1<b.indexOf(d.chain().name())});pv_viewer.fitTo(f);pv_viewer.requestRedraw()}}
function centerOnLigandPV(b,a){var c=pv_viewer.get(a+".ligands");null!=c&&(c=c.structure(),c=c.residueSelect(function(a){for(var c=0;c<b.length;c++)if(a.num()==b[c])return!0}),pv_viewer.fitTo(c),pv_viewer.requestRedraw())}
function highlightLigandPV(b,a,c){pv_viewer.rm("*ligandContactsHL");null!=pv_viewer.get(c+".ligands")&&b&&(a=pv_viewer.get(c).structure().residueSelect(function(a){var c=a.chain().name();a=a.num();if(c=b[c])for(var d=0;d<c.length;d++)if(a==c[d])return!0}),pv_viewer.lines(c+"ligandContactsHL",a),pv_viewer.requestRedraw())}
function changeRepPV(b){b.match(/(cartoon|tube|trace|lines|outline|fog)/)||(b="cartoon");"outline"==b?(jQuery.cookie("pv_outline",!pv_viewer.options("outline"),{expires:365,path:"/"}),pv_viewer.options("outline",!pv_viewer.options("outline"))):"fog"==b?(jQuery.cookie("pv_fog",!pv_viewer.options("fog"),{expires:365,path:"/"}),pv_viewer.options("fog",!pv_viewer.options("fog"))):b.match(/(cartoon|tube|trace|lines|ballAndStick)/)&&($("#repBtnLbl").text(b.charAt(0).toUpperCase()+b.substring(1)),jQuery.cookie("defaultRepr",
b,{expires:365,path:"/"}),pv_viewer.forEach(function(a){var c=a.name();if(!c.match(/(ligand|dna|res|LigandBond)/))switch(a=a.structure(),pv_viewer.rm(c),b){case "cartoon":pv_viewer.cartoon(c,a,{color:pv.color.uniform("white")});break;case "tube":pv_viewer.tube(c,a,{color:pv.color.uniform("white")});break;case "trace":pv_viewer.trace(c,a,{color:pv.color.uniform("white")});break;case "lines":pv_viewer.lines(c,a,{color:pv.color.uniform("white")});break;case "ballAndstick":pv_viewer.ballsAndSticks(c,
a,{color:pv.color.uniform("white")})}}))}function midpoint1d(b,a,c){return b+(a-b)*c}function midpoint3d(b,a,c){return[midpoint1d(b[0],a[0],c),midpoint1d(b[1],a[1],c),midpoint1d(b[2],a[2],c)]}function showWaterPV(){pv_viewer.ballsAndSticks("water",pv_viewer.get("template").structure().select({rnames:["HOH"]}))}function showWaterNGL(){log.console("showWaterNGL not implemented")}
function showWater(){0<$("#pv:visible",currentWin.document).length&&showWaterPV();0<$("#ngl:visible",currentWin.document).length&&showWaterNGL()}function toggleBond(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_bonds.getBondById(b,a).toggle(),deHighlightBond(b,a,!0))}function highlightBond(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&plip_bonds.getBondById(b,a).highlight()}
function deHighlightBond(b,a,c){PLIP.AbstractViewer.isStructureEnabled(b)&&(null==c&&(c=!0),plip_bonds.getBondById(b,a).dehighlight(!0,c))}function highlightBonds(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_bonds.getBondsById(b,a).forEach(function(a){a.highlight(!1)}),plip_residues.redraw(b))}function deHighlightBonds(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_bonds.getBondsById(b,a).forEach(function(a){a.dehighlight(!1)}),plip_residues.redraw(b))}
function clickBonds(b,a,c){toggleBonds(b,a,c);$("#plip_bonds_"+c).prop("checked")&&fitToBonds(b,a,c)}function toggleBonds(b,a,c){b=$("#plip_bonds_"+c);a=b.prop("checked");b.prop("checked",!a);b.trigger("change")}
function changeBondsCheckbox(b,a,c){var d=$("#plip_bonds_"+c),e=d.prop("checked");PLIP.AbstractViewer.isStructureEnabled(b)?(plip_bonds.getBondsById(b,a).forEach(function(a){e?a.show(!1):a.hide(!1);a.dehighlight(!1,!0)}),plip_residues.redraw(b),e&&plip_interactions_fit_bonds&&fitToBonds(b,a,c)):d.prop("checked",!1)}function showBonds(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_bonds.getBondsById(b,a).forEach(function(a){a.show(!1);a.dehighlight(!1,!0)}),plip_residues.redraw(b))}
function hideBonds(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_bonds.getBondsById(b,a).forEach(function(a){a.hide(!1);a.dehighlight(!1,!0)}),plip_residues.redraw(b))}function fitToBond(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&plip_bonds.getBondById(b,a).fitView()}
function fitToResidue(b,a,c){PLIP.AbstractViewer.isStructureEnabled(b)&&(residue=plip_residues.getResidue(b,a),c?(ligand=all_ligands.getLigandById(b,c),PLIP.AbstractViewer.fitView(b,[ligand],[residue])):PLIP.AbstractViewer.fitView(b,null,[residue]))}function fitToBonds(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&plip_bonds.fitViewBonds(b,a)}
function showResidues(b,a,c){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_residues.getResiduesByResId(b,a).forEach(function(a){a.show(!1)}),plip_residues.redraw(b))}function hideResidues(b,a,c){PLIP.AbstractViewer.isStructureEnabled(b)&&(plip_residues.getResiduesByResId(b,a).forEach(function(a){a.hide(!1)}),plip_residues.redraw(b))}function showLigands(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(all_ligands.getLigandsById(b,a).forEach(function(a){a.show(!1,!0)}),all_ligands.redraw(b))}
function hideLigands(b,a){PLIP.AbstractViewer.isStructureEnabled(b)&&(all_ligands.getLigandsById(b,a).forEach(function(a){a.hide(!1,null,!0)}),all_ligands.redraw(b))}
PLIP.Bonds=function(){var b={};this.hasStruc=function(a){return a in b};this.removeStruc=function(a){a in b&&delete b[a]};this.listStruc=function(){return Object.keys(b)};this.getBondById=function(a,c){if(a in b)return b[a].find(function(a){return a.id===c});console.log("getBondById: no strucId "+a);console.trace()};this.getBondsById=function(a,c){if(a in b)return b[a].filter(function(a){return c.includes(a.id)});console.log("getBondsById: no strucId "+a)};this.add=function(a){a.strucId in b||(b[a.strucId]=
[]);b[a.strucId].push(a)};this.showAll=function(a){for(var c=b[a],d=0;d<c.length;d++)c[d].isVisible()||c[d].show(!1);plip_residues.redraw(a)};this.hideAll=function(a){for(var c=b[a],d=0;d<c.length;d++)c[d].isVisible()&&c[d].hide(!1);plip_residues.redraw(a)};this.fitViewBonds=function(a,b){var c=this.getBondsById(a,b),e=c.map(function(a){return a.ligand}).filter(function(a,b,c){return c.indexOf(a)==b});c=c.map(function(a){return a.residue}).filter(function(a,b,c){return c.indexOf(a)==b});PLIP.AbstractViewer.fitView(a,
e,c)};this.refresh=function(a){for(var c in b[a])b[a][c].refresh()};this.refreshAll=function(){for(var a in b)PLIP.AbstractViewer.isStructureEnabled(a)&&this.refresh(a)}};
PLIP.Bond=function(b,a,c,d,e,f,g,h,l){var k=!1,p=!1,m=void 0,q="LigandBond"+b,n=void 0,r="LigandBondHighlight"+b;this.show=function(a){null==a&&(a=!0);this.isVisible()?console.log("Bond already visible"):PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(this.draw(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(a),k=!0,a&&pv_viewer.requestRedraw())};this.hide=function(a){null==a&&(a=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isVisible()&&(this.destroy(),k=!1,
void 0!==this.residue&&this.residue.hide(!1),this.ligand.hide(a),a&&pv_viewer.requestRedraw())};this.draw=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMesh(),this.coo1,this.coo2,plip_bond_num_dash,plip_bond_radius,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMesh(),this.coo1,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMesh(),this.coo2,this.coo3,plip_bond_num_dash,plip_bond_radius,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMesh(),
this.coo3,2*plip_bond_radius,this.color,!0))};this.destroy=function(){m=PLIP.AbstractViewer.removeMesh(q)};this.refresh=function(){this.destroy();this.isVisible()&&this.draw();this.destroyHighlight();this.isHighlighted()&&this.drawHighlight()};this.toggle=function(){this.isVisible()?this.hide():this.show()};this.isVisible=function(){return k};this.getBondMesh=function(){void 0==m&&(m=PLIP.AbstractViewer.newBondMesh(q));return m};this.highlight=function(a){null==a&&(a=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&
!this.isHighlighted()&&(this.drawHighlight(),void 0!==this.residue&&this.residue.show(!1),this.ligand.show(a),p=!0)};this.drawHighlight=function(){null==this.coo3?PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMeshHighlight(),this.coo1,this.coo2,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!0):(PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMeshHighlight(),this.coo1,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addBondLine(this.rname,this.getBondMeshHighlight(),
this.coo2,this.coo3,plip_higlight_bond_num_dash,plip_bond_radius*plip_higlight_factor,this.color,!1),PLIP.AbstractViewer.addWaterCircle(this.getBondMeshHighlight(),this.coo3,plip_bond_radius*plip_higlight_factor*2,this.color,!0))};this.destroyHighlight=function(){n=PLIP.AbstractViewer.removeMesh(r)};this.dehighlight=function(a){null==a&&(a=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&this.isHighlighted()&&this.isHighlighted()&&(this.destroyHighlight(),void 0!==this.residue&&this.residue.hide(!1),
this.ligand.hide(a),p=!1,a&&pv_viewer.requestRedraw())};this.toggleHighlight=function(){this.isHighlighted()?this.dehighlight():this.highlight()};this.isHighlighted=function(){return p};this.getBondMeshHighlight=function(){void 0==n&&(n=PLIP.AbstractViewer.newBondMesh(r));return n};this.fitView=function(){PLIP.AbstractViewer.fitView(this.strucId,[this.ligand],[this.residue])};this.getLigand=function(){return this.ligand};this.residue=plip_residues.getResidue(a,PLIP.makeResidueId(h[0],h[1],h[2]));this.rname=h;
this.id=b;this.strucId=a;this.ligand=c;this.coo1=d;this.coo2=e;this.coo3=f;this.color=g;l&&this.show()};PLIP.makeResidueId=function(b,a,c){return b+":"+a+c};
PLIP.Residue=function(b,a,c,d){var e=0;this.show=function(a){null==a&&(a=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(e++,0<e&&a&&plip_residues.redraw(this.strucId))};this.hide=function(a,b){null==a&&(a=!0);null==b&&(b=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(b?e=Math.max(e-1,0):alert("Did not decrement counter! "+this.id+": "+e),0==e&&a&&plip_residues.redraw(this.strucId))};this.isVisible=function(){return 0<e};this.getResId=function(){return this.chain+this.position};
this.strucId=b;this.id=PLIP.makeResidueId(a,c,d);this.chain=a;this.one_letter=c;this.position=d};
PLIP.Residues=function(){var b={};this.hasStruc=function(a){return a in b};this.removeStruc=function(a){a in b&&delete b[a]};this.listStruc=function(){return Object.keys(b)};this.getStruc=function(a){if(a in b)return b[a];void 0===a?(console.log("StrucId is undefined"),console.trace("StrucId is undefined")):(console.log("No such strucId: '"+a+"'"),console.trace("No such strucId: '"+a+"'"))};this.addResidue=function(a,c,d,e){a in b||(b[a]=[]);var f=PLIP.makeResidueId(c,d,e);f=this.getResidue(a,f);
void 0===f&&(f=new PLIP.Residue(a,c,d,e),this.getStruc(a).push(f));return f};this.getResidue=function(a,c){if(a in b)return this.getStruc(a).find(function(a){return a.id==c})};this.getResiduesByResId=function(a,c){if(a in b)return b[a].filter(function(a){return c.includes(a.id)})};this.getVisibleResidues=function(a){return this.getStruc(a).filter(function(a){return a.isVisible()})};this.getVisibleResiduesResId=function(a){return this.getVisibleResidues(a).map(function(a){return a.getResId()})};this.redraw=
function(a){highlightLigand(all_ligands.getVisibleLigandIds(a),this.getVisibleResiduesResId(a),a);pv_viewer.requestRedraw()};this.redrawAll=function(a){for(var c in b)PLIP.AbstractViewer.isStructureEnabled(c)&&this.redraw(c)}};
PLIP.Ligands=function(){var b={};this.hasStruc=function(a){return a in b};this.removeStruc=function(a){a in b&&delete b[a]};this.listStruc=function(){return Object.keys(b)};this.getStruc=function(a){if(a in b)return b[a];void 0===a?console.log("StrucId "+a+" is undefined"):console.log("No such strucId: '"+a+"'");console.trace()};this.getLigandById=function(a,c){if(a in b)return b[a].find(function(a){return a.id===c});console.log("getLigandById: no strucId "+a);console.trace()};this.getLigandsById=
function(a,c){if(a in b)return b[a].filter(function(a){return c.includes(a.id)});console.log("getLigandsById: no strucId "+a)};this.addLigand=function(a,c){a in b||(b[a]=[]);var d=this.getLigandById(a,c);void 0===d&&(d=new PLIP.Ligand(a,c),this.getStruc(a).push(d));return d};this.getVisibleLigands=function(a){return this.getStruc(a).filter(function(a){return a.isVisible()})};this.getVisibleLigandIds=function(a){return this.getVisibleLigands(a).map(function(a){return a.getLigandId()})};this.redraw=
function(a){highlightLigand(this.getVisibleLigandIds(a),plip_residues.getVisibleResiduesResId(a),a);pv_viewer.requestRedraw()};this.redrawAll=function(a){for(var c in b)PLIP.AbstractViewer.isStructureEnabled(c)&&this.redraw(c)}};
PLIP.Ligand=function(b,a){var c=0,d=[],e=[];this.show=function(a,b){null==a&&(a=!0);null==b&&(b=!1);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(c++,b&&d.forEach(function(a){a.show(!1)}),0<c&&a&&all_ligands.redraw(this.strucId))};this.hide=function(a,b,e){null==a&&(a=!0);null==e&&(e=!1);null==b&&(b=!0);PLIP.AbstractViewer.isStructureEnabled(this.strucId)&&(b?c=Math.max(c-1,0):alert("Did not decrement counter! "+this.id+": "+c),e&&d.forEach(function(a){a.hide(!1)}),0==c&&a&&all_ligands.redraw(this.strucId))};
this.addResidue=function(a){-1==d.indexOf(a)&&d.push(a)};this.addBond=function(a){-1==e.indexOf(a)&&e.push(a)};this.isVisible=function(){return 0<c};this.getLigandId=function(){return this.id};this.getResidues=function(){return d};this.strucId=b;this.position=this.id=a};
PLIP.AbstractViewerPV={newBondMesh:function(b){return pv_viewer.customMesh(b)},addWaterCircle:function(b,a,c,d,e){b.addSphere(a,c,{cap:!0,color:d})},addBondLine:function(r,b,a,c,d,e,f,g){for(g=1;g<=d;g++)b.addTube(midpoint3d(a,c,(2*g-2)/(2*d-1)),midpoint3d(a,c,(2*g-1)/(2*d-1)),e,{cap:!0,color:f})},removeMesh:function(b){pv_viewer.rm(b)},fitView:function(b,a,c){if(this.isStructureEnabled(b)){var d=c.map(function(a){return void 0===a?null:a.chain}),e=c.map(function(a){return void 0===a?null:a.position});
d.length!=e.length&&console.log("queryResidue -Chains and -Positions array lengths don't match: "+d.length+" != "+e.length);c=pv_viewer.get(b).structure().residueSelect(function(b){var c=b.chain().name();if("_"===c){if(!a)return!1;ligand_positions=a.map(function(a){return a.position});if(ligand_positions.includes(b.num()))return!0}for(var f=0;f<d.length;f++)if(d[f]===c&&e[f]===b.num())return!0;return!1});pv_viewer.fitTo(c);pv_viewer.requestRedraw()}},isStructureEnabled:function(b){return pv_viewer.get(b)?
!0:!1}};
var label_dict = {};
PLIP.AbstractViewerNGL={newBondMesh:function(b){return new NGL.Shape(b,{disableImpostor:!0})},addWaterCircle:function(b,a,c,d,e){b.addEllipsoid(a,d,c,[c,0,0],[0,c,0]);e&&ngl_stage.addComponentFromObject(b).addRepresentation("buffer")},addBondLine:function(r,b,a,c,d,e,f,g){for(var h=1;h<=d;h++){b.addCylinder(midpoint3d(a,c,(2*h-2)/(2*d-1)),midpoint3d(a,c,(2*h-1)/(2*d-1)),f,e);}if(!(r[1]+r[2] in label_dict)){b.addLabel(midpoint3d(a,c,(2*h-2)/(2*d-1)),[0,0,0],2.5, r[1]+r[2]);label_dict[r[1]+r[2]]=1;console.log(label_dict)};g&&ngl_stage.addComponentFromObject(b).addRepresentation("buffer")},removeMesh:function(b){removeNGLComponentByName(b)},fitView:function(b,
a,c){if(this.isStructureEnabled(b)){var d="";a&&(ligand_positions=a.map(function(a){return a.position}),d+="(("+ligand_positions.join(" or ")+") and :_)");if(void 0!==c[0]){a={};for(var e in c){var f=c[e],g=f.position;f=f.chain;a[f]?a[f].push(g):a[f]=[g]}for(f in a)""!=d&&(d+=" or "),d+="(("+a[f].join(" or ")+") and :"+f+")"}getNGLComponentByName(b).autoView(d,1E3)}},isStructureEnabled:function(b){return getNGLComponentByName(b)?!0:!1}};
function togglePLIPLigandContacts(b,a,c){$("#togglePLIPLigandContacts_"+b).hasClass("glyphicon-chevron-down")?showPLIPLigandContacts(b,a,c):hidePLIPLigandContacts(b,a,c)}function showPLIPLigandContacts(b,a,c){$("#PLIPligandContacts_"+b).show(100);setTimeout(function(){$("#togglePLIPLigandContacts_"+b).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down")},100);void 0!==c&&(showBonds(a,c),fitToBonds(a,c))}
function hidePLIPLigandContacts(b,a,c){$("#PLIPligandContacts_"+b).hide(100);setTimeout(function(){$("#togglePLIPLigandContacts_"+b).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up")},100);void 0!==c&&hideBonds(a,c)}var plip_interactions_fit_bonds=!0;
function togglePlipInteractions(b,a,c){label_dict = {};$("#togglePlipInteractions_"+b).hasClass("glyphicon-chevron-down")?($("#togglePlipInteractions_"+b).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#plipInteractions_"+b).show(),PLIP.AbstractViewer.isStructureEnabled(a)&&(plip_interactions_fit_bonds=!1,$.when($("#plipInteractions_"+b+" input").each(function(a,b){$(b).prop("checked",!0).trigger("change")})).done(function(){fitToBonds(a,c)}),plip_interactions_fit_bonds=!0)):($("#togglePlipInteractions_"+
b).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#plipInteractions_"+b).hide(),$("#plipInteractions_"+b+" input").each(function(a,b){$(b).prop("checked",!1).trigger("change")}))}
function changeLigandContacts4Checkbox(b,a,c,d){d=$("#chainContacts4_"+d);var e=d.prop("checked");PLIP.AbstractViewer.isStructureEnabled(b)?(plip_residues.getResiduesByResId(b,c).forEach(function(a){e?a.show(!1):a.hide(!1)}),a=all_ligands.getLigandById(b,a),e?a.show(!0,!1):a.hide(!0,null,!1),plip_residues.redraw(b)):d.prop("checked",!1)}
function clickLigandContacts4Checkbox(b,a,c,d){PLIP.AbstractViewer.isStructureEnabled(b)&&($("#chainContacts4_"+d).each(function(a,b){$(b).prop("checked",!$(b).prop("checked")).trigger("change")}),$("#chainContacts4_"+d).prop("checked")&&PLIP.AbstractViewer.fitView(b,[all_ligands.getLigandById(b,a)],plip_residues.getResiduesByResId(b,c)))}
function toggleResidueContacts(b,a,c){$("#toggleResidueContacts4_"+b).hasClass("glyphicon-chevron-down")?($("#toggleResidueContacts4_"+b).removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up"),$("#residueContacts4_"+b).show(),PLIP.AbstractViewer.isStructureEnabled(c)&&($("#residueContacts4_"+b+" input").each(function(a,b){$(b).prop("checked",!0).trigger("change")}),ligand=all_ligands.getLigandById(c,a),PLIP.AbstractViewer.fitView(c,[ligand],ligand.getResidues()))):($("#toggleResidueContacts4_"+
b).removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"),$("#residueContacts4_"+b).hide(),PLIP.AbstractViewer.isStructureEnabled(c)&&$("#residueContacts4_"+b+" input").each(function(a,b){$(b).prop("checked",!1).trigger("change")}))}
function toggleLigandGroup(b,a,c){$("#toggleLigandGroup_"+b).hasClass("glyphicon-chevron-down")?($("#toggleLigandGroup_"+b).addClass("glyphicon-chevron-up").removeClass("glyphicon-chevron-down"),$("#ligandGroup_"+b).show(),centerOnLigand(a,c)):($("#toggleLigandGroup_"+b).addClass("glyphicon-chevron-down").removeClass("glyphicon-chevron-up"),$("#ligandGroup_"+b+" .glyphicon-chevron-up").each(function(a,b){$(b).trigger("click")}),$("#ligandGroup_"+b).hide())};